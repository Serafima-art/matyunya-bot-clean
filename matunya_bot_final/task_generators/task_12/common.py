#task_12/common.py

"""
Общий модуль для Задания 12, содержащий все необходимые константы и
вспомогательные функции (утилиты), используемые как генераторами,
так и валидаторами.
"""
import re
from typing import Iterable, Optional

# ─────────────────────────────────────────────────────────────
# ОБЩИЕ КОНСТАНТЫ
# ─────────────────────────────────────────────────────────────

# Физические константы (ОГЭ-уровень, как в школьных учебниках)
G = 10             # Ускорение свободного падения, м/с²
PI = 3.14          # Число π (школьное приближение)
G_CONST = 6.67e-11 # Гравитационная постоянная, Н·м²/кг²
K_CONST = 9e9      # Электрическая постоянная, Н·м²/Кл²
R_UNIV = 8.31      # Универсальная газовая постоянная, Дж/(моль·К)
RHO_WATER = 1000   # Плотность воды, кг/м³
V_SOUND = 330      # Скорость звука в воздухе, м/с


# ─────────────────────────────────────────────────────────────
# УТИЛИТЫ ДЛЯ ГЕНЕРАТОРОВ
# ─────────────────────────────────────────────────────────────

def format_answer(value: float | int) -> str:
    """
    Форматирует числовой ответ в строку согласно стандарту ОГЭ.
    - Целые числа возвращаются без десятичной части (e.g., 18.0 -> "18").
    - Дробные числа возвращаются с запятой в качестве разделителя (e.g., 7.5 -> "7,5").
    """
    if float(value).is_integer():
        return str(int(value))
    return str(value).replace('.', ',')


# ─────────────────────────────────────────────────────────────
# УТИЛИТЫ ДЛЯ ВАЛИДАТОРОВ
# ─────────────────────────────────────────────────────────────

# Регулярное выражение для поиска чисел в тексте задачи.
# Распознает целые, дробные (с точкой или запятой), положительные и отрицательные.
# Примеры: "12", "12,5", "-7.5", ",5"
NUM = r"[-+]?(?:\d+(?:[.,]\d+)?|\d*(?:[.,]\d+))"

def to_float(s: str) -> float:
    """
    Преобразует строку с числом (возможно, с запятой) в float.
    """
    return float(s.replace(",", "."))

# ─────────────────────────────────────────────────────────────
# МОЩНЫЕ УТИЛИТЫ ДЛЯ СЛОЖНЫХ ВАЛИДАТОРОВ
# ─────────────────────────────────────────────────────────────

def _join_alts(xs: Iterable[str]) -> str:
    """Экранируем и склеиваем альтернативы для регэкспа."""
    return "|".join(re.escape(x) for x in xs)

def grab_labeled_number(text: str,
                        labels: Iterable[str],
                        units: Iterable[str] = (),
                        allow_words_equal: bool = True) -> Optional[float]:
    """
    Ищем число по меткам (labels), допускаем ':' или '=' или 'равно/равна'.
    Пример labels: ["F", "сила тяготения"]
    Возвращаем float или None.
    """
    lbl = _join_alts(labels)
    unit = _join_alts(units) if units else None

    patterns = [
        rf"(?:{lbl})\s*[:=]\s*({NUM})(?:\s*(?:{unit}))?\b" if unit
        else rf"(?:{lbl})\s*[:=]\s*({NUM})\b",
    ]
    if allow_words_equal:
        patterns.append(
            rf"(?:{lbl})\s*(?:равн[ао]|равно)\s*({NUM})(?:\s*(?:{unit}))?\b" if unit
            else rf"(?:{lbl})\s*(?:равн[ао]|равно)\s*({NUM})\b"
        )

    for p in patterns:
        m = re.search(p, text, flags=re.IGNORECASE)
        if m:
            return to_float(m.group(1))
    return None