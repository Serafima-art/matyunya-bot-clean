"""
task6_text_formatter.py ‚Äî –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç–µ—Ä –∏ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥—Ç–∏–ø–æ–≤ –∑–∞–¥–∞–Ω–∏—è ‚Ññ6.

–¶–µ–ª–∏:
‚Ä¢ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å (–≤ —Ç–æ–º —á–∏—Å–ª–µ ¬´–ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω–Ω–æ–µ¬ª);
‚Ä¢ –æ—á–∏—Å—Ç–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è –æ—Ç –∫—Ä–∞–∫–æ–∑—è–±—Ä, —Å—Ç—Ä–∞–Ω–Ω—ã—Ö –º–∏–Ω—É—Å–æ–≤, –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã—Ö –ø—Ä–æ–±–µ–ª–æ–≤;
‚Ä¢ –æ–±–µ—Ä–Ω—É—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∏ –¥–µ–ª–∏—Ç–µ–ª–∏ –≤ —Å–∫–æ–±–∫–∏;
‚Ä¢ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å (–∑–∞–ø—è—Ç—ã–µ, –ø—Ä–æ–±–µ–ª—ã, —Ç–æ—á–∫–∏, —É–º–Ω–æ–∂–µ–Ω–∏–µ ¬´¬∑¬ª);
‚Ä¢ –≤–µ—Ä–Ω—É—Ç—å None, –µ—Å–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–æ–≥–¥–∞ –¥–µ–ª–∞–µ—Ç –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é.
"""

from __future__ import annotations
import re
from decimal import Decimal, InvalidOperation
import random
from fractions import Fraction

# --- üîß –ë–∞–∑–æ–≤—ã–µ —Ä–µ–≥—É–ª—è—Ä–∫–∏ ---
_NEG_AFTER_OP_RE = re.compile(r'([¬∑*/])\s*(‚àí|-)\s*(\d+(?:[.,]\d+)?)')
_BAD_TRAILING_OP_RE = re.compile(r'[\+\-\*/:]$')
_NON_BREAK_SPACE_RE = re.compile(r'[\u00A0\u202F]')
_UNARY_MINUS_SPACE_RE = re.compile(r'(?:(?<=\()|^)\s*(?:‚àí|‚Äì|‚Äî|-)\s+(\d+(?:[.,]\d+)?)')
_WRAP_NEG_AFTER_PM_RE = re.compile(r'([+\-])\s*‚àí\s*(\d+(?:[.,]\d+)?)')
_ALLOWED = "0123456789 +-‚àí¬∑:/()"

# --- üîç –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è ---
def normalize_expression(expr: str) -> str:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π, –∏–¥–µ–∞–ª—å–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ.
    –§–∏–Ω–∞–ª—å–Ω–∞—è, –Ω–∞–¥—ë–∂–Ω–∞—è –≤–µ—Ä—Å–∏—è.
    """
    if not expr:
        return ""

    s = expr

    # 1. –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–æ–≤
    s = _NON_BREAK_SPACE_RE.sub(" ", s)
    s = s.replace("‚àí", "-").replace("‚Äì", "-").replace("‚Äî", "-")
    s = s.replace("√ó", "*").replace("¬∑", "*")  # –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º –≤—Å–µ —É–º–Ω–æ–∂–µ–Ω–∏—è –∫ *
    s = s.replace(":", "/")                    # –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º –≤—Å–µ –¥–µ–ª–µ–Ω–∏—è –∫ /

    # 2. –ó–∞–º–µ–Ω—è–µ–º –¥–µ—Å—è—Ç–∏—á–Ω—É—é —Ç–æ—á–∫—É –Ω–∞ –∑–∞–ø—è—Ç—É—é
    s = re.sub(r"(?<=\d)\.(?=\d)", ",", s)

    # 3. –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–±–µ–ª–æ–≤
    s = re.sub(r'\s*/\s*', '/', s)
    for op in ['+', '-', '*', '/']:
        s = s.replace(op, f' {op} ')

    # 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–µ —Å–∏–º–≤–æ–ª—ã —É–º–Ω–æ–∂–µ–Ω–∏—è –∏ –¥–µ–ª–µ–Ω–∏—è
    s = re.sub(r'\*', ' ¬∑ ', s)
    s = re.sub(r'/', ' : ', s)
    s = re.sub(r'(\d+)\s*:\s*(\d+)', r'\1/\2', s)  # –≤–Ω—É—Ç—Ä–∏ –¥—Ä–æ–±–µ–π –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—ç—à

    # 5. –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é —Ç–æ—á–∫—É —É–º–Ω–æ–∂–µ–Ω–∏—è
    s = re.sub(r'\s+', ' ', s).strip()
    s = s.replace(" ¬∑ ", " ‚ãÖ ")

    return s


def fix_negative_after_operators(expr: str) -> str:
    """–û–±–µ—Ä–Ω—É—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ –ø–æ—Å–ª–µ –∑–Ω–∞–∫–æ–≤ —É–º–Ω–æ–∂–µ–Ω–∏—è –∏–ª–∏ –¥–µ–ª–µ–Ω–∏—è –≤ —Å–∫–æ–±–∫–∏."""
    return _NEG_AFTER_OP_RE.sub(r'\1(‚àí\3)', expr)

def fix_unary_minus_spacing(expr: str) -> str:
    """
    –£–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ —É–Ω–∞—Ä–Ω–æ–≥–æ –º–∏–Ω—É—Å–∞ –≤ –Ω–∞—á–∞–ª–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
    –∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–∏: '‚àí 4,5' -> '‚àí4,5', '( ‚àí 2,1)' -> '(‚àí2,1)'.
    """
    return _UNARY_MINUS_SPACE_RE.sub(r'‚àí\1', expr)


def wrap_negative_after_plus_minus(expr: str) -> str:
    """
    –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —Å–ª–∞–≥–∞–µ–º–æ–µ –ø–æ—Å–ª–µ +/‚àí –≤ —Å–∫–æ–±–∫–∏:
    '7,7 + ‚àí6,3' -> '7,7 + (‚àí6,3)' ; 'a ‚àí ‚àí2,1' -> 'a ‚àí (‚àí2,1)'.
    """
    return _WRAP_NEG_AFTER_PM_RE.sub(r'\1 (‚àí\2)', expr)


def validate_expression(expr: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ."""
    if not expr or _BAD_TRAILING_OP_RE.search(expr):
        return False

    expr_eval = expr.replace("¬∑", "*").replace(",", ".")
    try:
        val = Decimal(str(eval(expr_eval)))
        if val.is_nan() or val.is_infinite():
            return False
    except (InvalidOperation, ZeroDivisionError, SyntaxError, NameError):
        return False
    except Exception:
        return False
    return True


def prepare_expression(src: str) -> str | None:
    """
    –ü—Ä–∏–≤–æ–¥–∏—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É –∏ —á–∏—Å—Ç–æ–º—É –≤–∏–¥—É.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –µ—Å–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
    """
    if src is None:
        return None

    # –£–±–∏—Ä–∞–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
    s = (src.replace("\u00a0", " ")
             .replace("\u202f", " ")
             .strip())

    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    s = "".join(ch for ch in s if ch in _ALLOWED)

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–Ω–∞–∫–∏ –∏ –ø—Ä–æ–±–µ–ª—ã
    s = s.replace("--", "+")
    s = re.sub(r"\s+", " ", s).strip()
    s = s.replace("-", "‚àí")  # –¥–ª–∏–Ω–Ω–æ–µ —Ç–∏—Ä–µ

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
    if not s or not re.search(r"[0-9]", s):
        return None
    if not re.search(r"[/:¬∑+\-‚àí()]", s):
        return None
    if re.search(r"\(\s*\)", s):
        return None

    return s


def _fmt(x: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–∞ –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π (–∑–∞–º–µ–Ω–∞ —Ç–æ—á–∫–∏ –Ω–∞ –∑–∞–ø—è—Ç—É—é, —Å–∫–æ–±–∫–∏ –¥–ª—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö)."""
    s = f"{x:.2f}".replace(".", ",")
    s = s.rstrip("0").rstrip(",")
    return f"({s})" if x < 0 else s


def _fmt_answer(x: float, use_comma: bool = False) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –±–µ–∑ —Å–∫–æ–±–æ–∫.
    –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å —Ç–æ—á–∫–æ–π, –º–∞–∫—Å–∏–º—É–º –¥–≤–∞ –∑–Ω–∞–∫–∞.
    –ï—Å–ª–∏ use_comma=True, –∑–∞–º–µ–Ω—è–µ—Ç —Ç–æ—á–∫—É –Ω–∞ –∑–∞–ø—è—Ç—É—é.
    """
    try:
        val = float(x)
        s = f"{val:.2f}"
    except Exception:
        s = str(x)

    s = s.rstrip("0").rstrip(".")
    if s == "-0":
        s = "0"

    if use_comma:
        if "." in s:
            s = s.replace(".", ",")
        if "," not in s and any(ch.isdigit() for ch in s):
            s = f"{s},0"
    else:
        if "." not in s and any(ch.isdigit() for ch in s):
            if "," in str(x):
                s = s.replace(",", ".")
    return s


# --- üåü –ï–¥–∏–Ω—ã–π —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç–µ—Ä –¥–ª—è –∑–∞–¥–∞–Ω–∏—è 6 --- #

def normalize_for_display(expr: str) -> str:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è ‚Ññ6.
    –î–µ–ª–∞–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º—ã–º –∏ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö –ø–æ–¥—Ç–∏–ø–∞—Ö: common_fractions, decimal_fractions, mixed_fractions, powers.
    """
    if not expr:
        return ""

    # 1. –ë–∞–∑–æ–≤–∞—è —á–∏—Å—Ç–∫–∞ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
    expr = normalize_expression(expr)

    # 2. –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ –ø–æ—Å–ª–µ ¬∑, /, :
    expr = fix_negative_after_operators(expr)

    # 3. –ú–µ–Ω—è–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –º–∏–Ω—É—Å –Ω–∞ –¥–ª–∏–Ω–Ω—ã–π (–ì–û–°–¢)
    expr = expr.replace("-", "‚àí")

    # 4. –ï–¥–∏–Ω—ã–π —Å–∏–º–≤–æ–ª —É–º–Ω–æ–∂–µ–Ω–∏—è
    expr = expr.replace("¬∑", "‚ãÖ")

    # 5. –§–∏–Ω–∞–ª—å–Ω–∞—è —á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–µ–ª–æ–≤
    expr = re.sub(r"\s+", " ", expr).strip()

    return expr

__all__ = [
    "normalize_expression",
    "fix_negative_after_operators",
    "fix_unary_minus_spacing",
    "wrap_negative_after_plus_minus",
    "validate_expression",
    "prepare_expression",
    "_fmt",
    "_fmt_answer",
]
