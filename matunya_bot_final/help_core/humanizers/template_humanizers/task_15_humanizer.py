"""
–®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–µ—à–µ–Ω–∏–π –ó–∞–¥–∞–Ω–∏—è 15 (–ü–ª–∞–Ω–∏–º–µ—Ç—Ä–∏—è).
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –°—Ü–µ–Ω–∞—Ä–∏–∏ (Narrative), –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è.
"""

from __future__ import annotations
from typing import Any, Dict, List
import re

CONDITIONAL_PATTERN = re.compile(r"\{if\s+not\s+([^}]+)\}|\{if\s+([^}]+)\}|\{endif\}")


def _apply_conditionals(template: str, context: Dict[str, Any]) -> str:
    """Resolve {if ...}/{if not ...} blocks in a single pass."""
    result_parts: List[str] = []
    stack: List[bool] = []
    pos = 0

    for match in CONDITIONAL_PATTERN.finditer(template):
        is_active = all(stack) if stack else True
        segment = template[pos:match.start()]
        if is_active:
            result_parts.append(segment)

        if match.group(1) is not None:
            cond_value = not bool(context.get(match.group(1)))
            stack.append(cond_value)
        elif match.group(2) is not None:
            cond_value = bool(context.get(match.group(2)))
            stack.append(cond_value)
        else:
            if stack:
                stack.pop()
        pos = match.end()

    is_active = all(stack) if stack else True
    if is_active:
        result_parts.append(template[pos:])

    return "".join(result_parts)

# =================================================================================================
# –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –°–¶–ï–ù–ê–†–ò–ï–í
# =================================================================================================

TASK_15_SCENARIOS = {
    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 1.1: –í–Ω–µ—à–Ω–∏–π —É–≥–æ–ª
    # -------------------------------------------------------------------------
    "triangle_external_angle": {
        "idea": (
            "–û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –∫–ª—é—á–µ–≤–æ–º —Å–≤–æ–π—Å—Ç–≤–µ –≤–Ω–µ—à–Ω–µ–≥–æ —É–≥–ª–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞.\n"
            "<b>–í–Ω–µ—à–Ω–∏–π —É–≥–æ–ª —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–µ–Ω —Å—É–º–º–µ –¥–≤—É—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤, –Ω–µ —Å–º–µ–∂–Ω—ã—Ö —Å –Ω–∏–º.</b>\n"
            "–≠—Ç–æ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –∏ –ø—Ä—è–º–æ–π –ø—É—Ç—å –∫ –æ—Ç–≤–µ—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–µ.\n"
            "–ï—Å—Ç—å –∏ –≤—Ç–æ—Ä–æ–π, –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–π, –Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏:\n"
            "–ù–∞–π—Ç–∏ —Ç—Ä–µ—Ç–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–≥–æ–ª: <b>‚à†{target_vertex} = 180¬∞ - (‚à†A + ‚à†B)</b>.\n"
            "–ù–∞–π—Ç–∏ —Å–º–µ–∂–Ω—ã–π —Å –Ω–∏–º –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª: –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = 180¬∞ - ‚à†{target_vertex}</b>."
        ),
        "steps_templates": [
            (
                "<b>–®–∞–≥ 1.</b> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:\n"
                "–í —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–µ <b>{triangle_name}</b> —É–≥–æ–ª <b>A</b> —Ä–∞–≤–µ–Ω <b>{angle_a_val}¬∞</b>, "
                "–∞ —É–≥–æ–ª <b>B</b> —Ä–∞–≤–µ–Ω <b>{angle_b_val}¬∞</b>. "
                "–ù–∞–π–¥–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª –ø—Ä–∏ –≤–µ—Ä—à–∏–Ω–µ <b>{target_vertex}</b>.\n"
                "–î–∞–Ω–æ: <b>‚à†A = {angle_a_val}¬∞, ‚à†B = {angle_b_val}¬∞</b>.\n"
                "–ù–∞–π—Ç–∏: –í–Ω–µ—à–Ω–∏–π —É–≥–æ–ª –ø—Ä–∏ –≤–µ—Ä—à–∏–Ω–µ <b>{target_vertex}</b>."
            ),
            (
                "<b>–®–∞–≥ 2.</b> –í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –∫–ª—é—á–µ–≤—ã–º —Å–≤–æ–π—Å—Ç–≤–æ–º: –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª —Ä–∞–≤–µ–Ω —Å—É–º–º–µ –¥–≤—É—Ö –¥—Ä—É–≥–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤, –Ω–µ —Å–º–µ–∂–Ω—ã—Ö —Å –Ω–∏–º.\n"
                "‚û°Ô∏è –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = ‚à†A + ‚à†B</b>"
            ),
            (
                "<b>–®–∞–≥ 3.</b> –ü–æ–¥—Å—Ç–∞–≤–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º—É–ª—É.\n"
                "‚û°Ô∏è –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = {angle_a_val}¬∞ + {angle_b_val}¬∞ = {res}¬∞</b>"
            ),
            (
                "<b>–®–∞–≥ 4.</b> (–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞) –ü—Ä–æ–≤–µ—Ä–∏–º —Å–µ–±—è –≤—Ç–æ—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º.\n"
                "–ù–∞–π–¥–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–≥–æ–ª <b>{target_vertex}</b>: <b>‚à†{target_vertex} = 180¬∞ - ({angle_a_val}¬∞ + {angle_b_val}¬∞) = 180¬∞ - {res}¬∞ = {internal_c_val}¬∞</b>.\n"
                "–ù–∞–π–¥–µ–º –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª –ø—Ä–∏ <b>{target_vertex}</b>, –∫–æ—Ç–æ—Ä—ã–π —Å–º–µ–∂–µ–Ω —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º: –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = 180¬∞ - {internal_c_val}¬∞ = {res}¬∞</b>.\n"
                "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–≤–ø–∞–ª–∏, —Ä–µ—à–µ–Ω–∏–µ –≤–µ—Ä–Ω–æ–µ."
            )
        ],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": [
            "–ó–∞–ø–æ–º–Ω–∏ –≥–ª–∞–≤–Ω—É—é —Ñ–æ—Ä–º—É–ª—É ‚Äî —ç—Ç–æ —Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å. –ù–∞ —ç–∫–∑–∞–º–µ–Ω–µ –≤–∞–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.",
            "–í—Å–µ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π —Å—Ö–µ–º–∞—Ç–∏—á–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è, –∫–∞–∫–∏–µ —É–≥–ª—ã —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å.",
            "–í –æ—Ç–≤–µ—Ç –ø—Ä–æ—Å—è—Ç —á–∏—Å–ª–æ –±–µ–∑ –∑–Ω–∞–∫–∞ –≥—Ä–∞–¥—É—Å–∞. –ü—Ä–æ—Å—Ç–æ <b>{res}</b>.",
            "–°–≤–æ–π—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞."
        ]
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 1.2: –ë–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞
    # -------------------------------------------------------------------------
    "angle_bisector_find_half_angle": {
        "idea": (
            "–ó–∞–¥–∞—á–∞-–ª–æ–≤—É—à–∫–∞ –Ω–∞ –∑–Ω–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞. –í—Å—ë —Ä–µ—à–µ–Ω–∏–µ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏:\n"
            "<b>–ë–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ ‚Äî —ç—Ç–æ –ª—É—á, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –≤–µ—Ä—à–∏–Ω—ã —É–≥–ª–∞ –∏ –¥–µ–ª–∏—Ç –µ–≥–æ –Ω–∞ –¥–≤–∞ —Ä–∞–≤–Ω—ã—Ö —É–≥–ª–∞.</b>\n"
            "–¢–æ –µ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —É–≥–æ–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–∑—É–µ—Ç –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω–æ–π, –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —É–≥–æ–ª –Ω–∞ 2."
        ),
        "steps_templates": [
        (
            "<b>–®–∞–≥ 1.</b> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:\n"
            "–í —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–µ <b>{triangle_name}</b> –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ <b>{full_angle_name} = {full_angle_val}¬∞</b>, "
            "<b>{bisector_name}</b> ‚Äî –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞. –ù–∞–π–¥–∏—Ç–µ —É–≥–æ–ª <b>{target_half_name}</b>.\n"
            "–î–∞–Ω–æ: <b>{full_angle_name} = {full_angle_val}¬∞</b>.\n"
            "–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: <b>{bisector_name}</b> ‚Äî –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞.\n"
            "–ù–∞–π—Ç–∏: <b>‚à†{target_half_name}</b>."
        ),
        (
            "<b>–®–∞–≥ 2.</b> –í—Å–ø–æ–º–Ω–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å—ã.\n"
            "–†–∞–∑ <b>{bisector_name}</b> ‚Äî –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ —É–≥–ª–∞ <b>{full_angle_name}</b>, –æ–Ω–∞ –¥–µ–ª–∏—Ç –µ–≥–æ –Ω–∞ –¥–≤–∞ —Ä–∞–≤–Ω—ã—Ö —É–≥–ª–∞: "
            "<b>{target_half_name}</b> –∏ <b>{second_half_name}</b>.\n"
            "‚û°Ô∏è <b>‚à†{target_half_name} = ‚à†{second_half_name} = {full_angle_name} / 2</b>"
        ),
        (
            "<b>–®–∞–≥ 3.</b> –ü–æ–¥—Å—Ç–∞–≤–∏–º –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ.\n"
            "‚û°Ô∏è <b>‚à†{target_half_name} = {full_angle_val}¬∞ / 2 = {res}¬∞</b>"
        )
    ],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": [
            "–ö–ª—é—á –∫ –∑–∞–¥–∞—á–µ ‚Äî —Å–ª–æ–≤–æ \"–±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞\". –ï—Å–ª–∏ —Ç—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ –æ–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç, –∑–∞–¥–∞—á–∞ —Ä–µ—à–∞–µ—Ç—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥.",
            "–¢—Ä–∏ –≥–ª–∞–≤–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–∏–º–µ—Ç—Ä–∏–∏: –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ (–¥–µ–ª–∏—Ç —É–≥–æ–ª –ø–æ–ø–æ–ª–∞–º), –º–µ–¥–∏–∞–Ω–∞ (–¥–µ–ª–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–ø–æ–ª–∞–º), –≤—ã—Å–æ—Ç–∞ (–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ). –ù–µ –ø—É—Ç–∞–π –∏—Ö!",
            "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π, –∫–∞–∫–æ–π –∏–∑ –¥–≤—É—Ö –ø–æ–ª–æ–≤–∏–Ω—á–∞—Ç—ã—Ö —É–≥–ª–æ–≤ –ø—Ä–æ—Å—è—Ç –Ω–∞–π—Ç–∏. –í —Å–ª—É—á–∞–µ –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å—ã –æ–Ω–∏ —Ä–∞–≤–Ω—ã, –Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á–∞—Ö —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–∂–Ω–æ."
        ]
    },

    # =========================================================================
    # –¢–ï–ú–ê 2: –ü–†–û–ò–ó–í–û–õ–¨–ù–´–ï –¢–†–ï–£–ì–û–õ–¨–ù–ò–ö–ò
    # =========================================================================

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 2.1: triangle_area_by_sin
    # -------------------------------------------------------------------------
    "triangle_area_by_sin": {
        "narratives": {
            "from_sin_value": {
                "idea": (
                    "–ó–∞–¥–∞—á–∞ –Ω–∞ –ø—Ä—è–º–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª –ø–ª–æ—â–∞–¥–∏ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞.\n"
                    "<b>–ü–ª–æ—â–∞–¥—å —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–≤—É—Ö –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω –Ω–∞ —Å–∏–Ω—É—Å —É–≥–ª–∞ –º–µ–∂–¥—É –Ω–∏–º–∏.</b>\n"
                    "–§–æ—Ä–º—É–ª–∞: <b>S = 1/2 ¬∑ a ¬∑ b ¬∑ sin Œ≥</b>, –≥–¥–µ <b>a –∏ b</b> ‚Äî —Å—Ç–æ—Ä–æ–Ω—ã, –∞ <b>Œ≥ (–≥–∞–º–º–∞)</b> ‚Äî —É–≥–æ–ª, –∑–∞–∫–ª—é—á–µ–Ω–Ω—ã–π –∏–º–µ–Ω–Ω–æ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –¥–≤—É–º—è —Å—Ç–æ—Ä–æ–Ω–∞–º–∏."
                ),
                "steps_templates": [
                    (
                        "<b>–®–∞–≥ 1</b>. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:\n"
                        "–î–∞–Ω–æ: –°—Ç–æ—Ä–æ–Ω–∞ <b>{side1_name} = {side1_val}</b>, –°—Ç–æ—Ä–æ–Ω–∞ <b>{side2_name} = {side2_val}</b>.\n"
                        "–£–≥–æ–ª –º–µ–∂–¥—É –Ω–∏–º–∏: <b>{angle_name_human}</b>.\n"
                        "–°–∏–Ω—É—Å —ç—Ç–æ–≥–æ —É–≥–ª–∞: <b>sin{angle_name_human} = {sin_val}</b>.\n"
                        "–ù–∞–π—Ç–∏: –ü–ª–æ—â–∞–¥—å <b>S</b>."
                    ),
                    (
                        "<b>–®–∞–≥ 2</b>. –ó–∞–ø–∏—à–µ–º —Ñ–æ—Ä–º—É–ª—É –ø–ª–æ—â–∞–¥–∏ —á–µ—Ä–µ–∑ —Å–∏–Ω—É—Å.\n"
                        "‚û°Ô∏è <b>S = 1/2 ¬∑ {side1_name} ¬∑ {side2_name} ¬∑ sin‚à†{angle_name}</b>"
                    ),
                    (
                        "<b>–®–∞–≥ 3</b>. –ü–æ–¥—Å—Ç–∞–≤–∏–º –≤ —Ñ–æ—Ä–º—É–ª—É –≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –Ω–∞–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –≤—ã—á–∏—Å–ª–∏–º.\n"
                        "‚û°Ô∏è <b>S = 1/2 ¬∑ {side1_val} ¬∑ {side2_val} ¬∑ {sin_val}</b>\n"
                        "{detailed_computation_line}"
                    )
                ],
                # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Tips –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ, –Ω–æ –∑–¥–µ—Å—å –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –Ω–∞–±–æ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                "tips_key": "default"
            },
            "from_degrees": {
                "idea": (
                    "–ó–∞–¥–∞—á–∞ —Ä–µ—à–∞–µ—Ç—Å—è –ø–æ —Ç–æ–π –∂–µ –∫–ª—é—á–µ–≤–æ–π —Ñ–æ—Ä–º—É–ª–µ (–ø–ª–æ—â–∞–¥—å —á–µ—Ä–µ–∑ —Å–∏–Ω—É—Å), –Ω–æ —Å –æ–¥–Ω–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º –≤ –Ω–∞—á–∞–ª–µ.\n"
                    "<b>–ü–ª–æ—â–∞–¥—å —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–≤—É—Ö –µ–≥–æ —Å—Ç–æ—Ä–æ–Ω –Ω–∞ —Å–∏–Ω—É—Å —É–≥–ª–∞ –º–µ–∂–¥—É –Ω–∏–º–∏.</b>\n"
                    "–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –∑–∞–¥–∞—á ‚Äî —É–≥–æ–ª –¥–∞–Ω –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, <b>30¬∞, 45¬∞, 120¬∞</b>). –ü–æ—ç—Ç–æ–º—É, –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—É–ª—ã, –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —à–∞–≥: <b>–Ω–∞–π—Ç–∏ —Å–∏–Ω—É—Å —ç—Ç–æ–≥–æ —É–≥–ª–∞</b>, –≤—Å–ø–æ–º–Ω–∏–≤ –µ–≥–æ —Ç–∞–±–ª–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ."
                ),
                "steps_templates": [
                    (
                        "<b>–®–∞–≥ 1</b>. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:\n"
                        "–î–∞–Ω–æ: –°—Ç–æ—Ä–æ–Ω–∞ <b>{side1_name} = {side1_val}</b>, –°—Ç–æ—Ä–æ–Ω–∞ <b>{side2_name} = {side2_val}</b>.\n"
                        "–£–≥–æ–ª –º–µ–∂–¥—É –Ω–∏–º–∏: <b>{angle_name_human} = {angle_val}¬∞</b>.\n"
                        "–ù–∞–π—Ç–∏: –ü–ª–æ—â–∞–¥—å <b>S</b>."
                    ),
                    (
                        "<b>–®–∞–≥ 2</b>. –ó–∞–ø–∏—à–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É–ª—É –ø–ª–æ—â–∞–¥–∏ —á–µ—Ä–µ–∑ —Å–∏–Ω—É—Å.\n"
                        "‚û°Ô∏è <b>S = 1/2 ¬∑ {side1_name} ¬∑ {side2_name} ¬∑ sin‚à†{angle_name}</b>"
                    ),
                    (
                        "<b>–®–∞–≥ 3</b>. –ù–∞–π–¥–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏–Ω—É—Å–∞ –¥–ª—è –Ω–∞—à–µ–≥–æ —É–≥–ª–∞.\n"
                        "–£–≥–æ–ª <b>{angle_name_human}</b> —Ä–∞–≤–µ–Ω <b>{angle_val}¬∞</b>. –≠—Ç–æ —Ç–∞–±–ª–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –Ω–∞–∏–∑—É—Å—Ç—å.\n"
                        "‚û°Ô∏è <b>sin {angle_val}¬∞ = {sin_val_str}</b>"
                    ),
                    (
                        "<b>–®–∞–≥ 4</b>. –ü–æ–¥—Å—Ç–∞–≤–∏–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤ —Ñ–æ—Ä–º—É–ª—É –∏ –≤—ã—á–∏—Å–ª–∏–º.\n"
                        "‚û°Ô∏è <b>S = 1/2 ¬∑ {side1_val} ¬∑ {side2_val} ¬∑ {sin_val_str}</b>\n"
                        "{detailed_computation_line}"
                    )
                ],
                "tips_key": "from_degrees"
            }
        },
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ë–ª–æ–∫ tips —Ç–µ–ø–µ—Ä—å –∑–¥–µ—Å—å, –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
        "tips": {
            "default": [
                "–ì–ª–∞–≤–Ω–æ–µ ‚Äî —É–≥–æ–ª –ú–ï–ñ–î–£ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏! –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ –∑–∞–¥–∞—á–µ –¥–∞–Ω —Å–∏–Ω—É—Å –∏–º–µ–Ω–Ω–æ —Ç–æ–≥–æ —É–≥–ª–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–µ–∂–¥—É –¥–≤—É–º—è –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏.",
                "–ù–µ –∑–∞–±—É–¥—å –ø—Ä–æ <b>1/2</b>! –≠—Ç–æ —Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —ç—Ç–æ–π —Ñ–æ—Ä–º—É–ª—ã.",
                "–°–∏–Ω—É—Å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç), –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —É–º–Ω–æ–∂–∏—Ç—å. –ù–µ –ø—É–≥–∞–π—Å—è –¥—Ä–æ–±–µ–π.",
                "–ò–Ω–æ–≥–¥–∞ –≤ –∑–∞–¥–∞—á–µ –±—É–¥–µ—Ç –¥–∞–Ω —Å–∞–º —É–≥–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, <b>30¬∞, 45¬∞, 60¬∞</b>). –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ –≤—Å–ø–æ–º–Ω–∏—Ç—å —Ç–∞–±–ª–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–∏–Ω—É—Å–æ–≤: <b>sin 30¬∞ = 1/2, sin 45¬∞ = ‚àö2/2, sin 60¬∞ = ‚àö3/2</b>."
            ],
            "from_degrees": [
                "–ü–µ—Ä–≤—ã–π —à–∞–≥ ‚Äî –≤—Å–ø–æ–º–Ω–∏—Ç—å —Å–∏–Ω—É—Å! –ï—Å–ª–∏ —É–≥–æ–ª \"–∫—Ä–∞—Å–∏–≤—ã–π\" <b>(30¬∞, 45¬∞, 60¬∞ –∏ –∏—Ö \"—Å–æ—Å–µ–¥–∏\" 150¬∞, 135¬∞, 120¬∞)</b>, –µ–≥–æ —Å–∏–Ω—É—Å –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –Ω–∞–∏–∑—É—Å—Ç—å. –≠—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç –¥—Ä–∞–≥–æ—Ü–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–µ.",
                "–î–ª—è —Ç—É–ø—ã—Ö —É–≥–ª–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–æ—Ä–º—É–ª–∞ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è: <b>sin(180¬∞ - Œ±) = sin(Œ±)</b>. –ù–∞–ø—Ä–∏–º–µ—Ä, <b>sin(150¬∞) = sin(180¬∞ - 150¬∞) = sin(30¬∞) = 1/2</b>.",
                "–ù–µ –∑–∞–±—É–¥—å –ø—Ä–æ <b>1/2</b>! –≠—Ç–æ —Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —ç—Ç–æ–π —Ñ–æ—Ä–º—É–ª—ã.",
                "–ì–ª–∞–≤–Ω–æ–µ ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —É–≥–æ–ª –¥–∞–Ω –∏–º–µ–Ω–Ω–æ –º–µ–∂–¥—É –¥–≤—É–º—è –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏."
            ]
        }
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 2.2: triangle_area_by_dividing_point
    # -------------------------------------------------------------------------
    "triangle_area_by_dividing_point": {
        "narratives": {
            "find_small_from_big": {
                "idea": (
                    "–í—Å—è –∑–∞–¥–∞—á–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Å–≤–æ–π—Å—Ç–≤–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ —Å –æ–±—â–µ–π –≤—ã—Å–æ—Ç–æ–π.\n"
                    "–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –Ω–∞ –æ–¥–Ω–æ–π –≤—ã—Å–æ—Ç–µ –∏–∑ –≤–µ—Ä—à–∏–Ω—ã <b>B</b>, –∏–º–µ—é—Ç –ø–ª–æ—â–∞–¥–∏, "
                    "–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ <b>–æ—Å–Ω–æ–≤–∞–Ω–∏—è–º —ç—Ç–∏—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤</b>.\n"
                ),
                "steps_templates": [
                    (
                        "<b>–®–∞–≥ 1.</b> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ:\n"
                        "–î–∞–Ω–æ: S(ABC) = <b>{s_abc_val}</b>, AD = <b>{ad_val}</b>, DC = <b>{dc_val}</b>.\n"
                        "–ù–∞–π—Ç–∏: <b>{target_area_name}</b>."
                    ),
                    (
                        "<b>–®–∞–≥ 2.</b> –ù–∞–π–¥–µ–º –ø–æ–ª–Ω—É—é –¥–ª–∏–Ω—É –æ—Å–Ω–æ–≤–∞–Ω–∏—è AC.\n"
                        "‚û°Ô∏è <b>AC = AD + DC = {ad_val} + {dc_val} = {base_total_val}</b>"
                    ),
                    (
                        "<b>–®–∞–≥ 3.</b> –ù–∞–π–¥–µ–º, –∫–∞–∫—É—é –¥–æ–ª—é –æ—Ç –≤—Å–µ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–∏—è AC —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω–∏–µ <b>{target_base_name}</b>.\n"
                        "‚û°Ô∏è –î–æ–ª—è = {target_base_name} / AC = <b>{target_base_share_str}</b>"
                    ),
                    (
                        "<b>–®–∞–≥ 4.</b> –ü–ª–æ—â–∞–¥—å <b>{target_area_name}</b> —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∞–∫—É—é –∂–µ –¥–æ–ª—é –æ—Ç –æ–±—â–µ–π –ø–ª–æ—â–∞–¥–∏.\n"
                        "‚û°Ô∏è <b>{target_area_name} = S(ABC) ¬∑ ({target_base_share_str}) = {s_abc_val} ¬∑ ({target_base_share_str}) = {res}</b>"
                    ),
                ],
                "tips_key": "find_small_from_big"
            },
            "find_from_small": {
                "idea": (
                    "–í—Å—è –∑–∞–¥–∞—á–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Å–≤–æ–π—Å—Ç–≤–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ —Å –æ–±—â–µ–π –≤—ã—Å–æ—Ç–æ–π.\n"
                    "–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∏, –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –Ω–∞ –æ–¥–Ω–æ–π –≤—ã—Å–æ—Ç–µ –∏–∑ –≤–µ—Ä—à–∏–Ω—ã <b>B</b>, –∏–º–µ—é—Ç –ø–ª–æ—â–∞–¥–∏, "
                    "–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ <b>–æ—Å–Ω–æ–≤–∞–Ω–∏—è–º —ç—Ç–∏—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤</b>.\n"
                ),
                "steps_templates": [
                    (
                        "<b>–®–∞–≥ 1.</b> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ:\n"
                        "–î–∞–Ω–æ: <b>{known_area_name} = {known_area_val}</b>. –û—Å–Ω–æ–≤–∞–Ω–∏—è –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫–∞–∫ <b>AD : DC = {ad_val} : {dc_val}</b>."
                    ),
                    (
                        "<b>–®–∞–≥ 2.</b> –ù–∞–π–¥–µ–º, —Å–∫–æ–ª—å–∫–æ –ø–ª–æ—â–∞–¥–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ –æ–¥–Ω—É \"—á–∞—Å—Ç—å\" –æ—Ç–Ω–æ—à–µ–Ω–∏—è.\n"
                        "–ü–ª–æ—â–∞–¥—å <b>{known_area_name}</b> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç <b>{known_base_parts}</b> —á–∞—Å—Ç—è–º.\n"
                        "‚û°Ô∏è <b>1 —á–∞—Å—Ç—å = {known_area_val} / {known_base_parts} = {one_part_val}</b>"
                    ),
                    (
                    "<b>–®–∞–≥ 3.</b> –ù–∞–π–¥–µ–º –∏—Å–∫–æ–º—É—é –ø–ª–æ—â–∞–¥—å.\n"

                    "{if is_find_big}"
                    "–ü–ª–æ—â–∞–¥—å <b>S(ABC)</b> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç <b>{total_parts}</b> —á–∞—Å—Ç—è–º (<b>{ad_val} + {dc_val}</b>).\n"
                    "‚û°Ô∏è <b>S(ABC) = (1 —á–∞—Å—Ç—å) ¬∑ {total_parts} = {one_part_val} ¬∑ {total_parts} = {total_area_val}</b>"
                    "{endif}"

                    "{if not is_find_big}"
                    "–ü–ª–æ—â–∞–¥—å <b>{target_area_name}</b> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç <b>{target_base_parts}</b> —á–∞—Å—Ç—è–º.\n"
                    "‚û°Ô∏è <b>{target_area_name} = (1 —á–∞—Å—Ç—å) ¬∑ {target_base_parts} = {one_part_val} ¬∑ {target_base_parts} = {other_small_area_val}</b>\n"
                    "{endif}"
                    )
                ],
                "tips_key": "default"
            }
        },
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": {
            "find_small_from_big": [
                "–ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ: –í–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ –±–æ–ª—å—à–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ (–ø—Ä–∏ –æ–±—â–µ–π –≤—ã—Å–æ—Ç–µ), –≤–æ —Å—Ç–æ–ª—å–∫–æ –∂–µ —Ä–∞–∑ –∏ –µ–≥–æ –ø–ª–æ—â–∞–¥—å –±–æ–ª—å—à–µ.",
                "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ ‚Äî —ç—Ç–æ –∫—É—Å–æ–∫ –ø–∏—Ä–æ–≥–∞. –†–∞–∑—Ä–µ–∑ <b>BD</b> –¥–µ–ª–∏—Ç –µ–≥–æ –Ω–∞ –¥–≤–∞ –∫—É—Å–∫–∞. –ß–µ–º —à–∏—Ä–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∫—É—Å–∫–∞ (<b>AD</b> –∏–ª–∏ <b>DC</b>), —Ç–µ–º –±–æ–ª—å—à–µ –µ–≥–æ –ø–ª–æ—â–∞–¥—å.",
                "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π, –ø–ª–æ—â–∞–¥—å –∫–∞–∫–æ–≥–æ –∏–∑ –º–µ–Ω—å—à–∏—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ (<b>ABD</b> –∏–ª–∏ <b>BCD</b>).",
                "–ï—Å–ª–∏ –≤ —É—Å–ª–æ–≤–∏–∏ –¥–∞–Ω–æ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, <b>1:4</b>), —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤—Å—ë –æ—Å–Ω–æ–≤–∞–Ω–∏–µ –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ <b>1 + 4 = 5</b> —Ä–∞–≤–Ω—ã—Ö —á–∞—Å—Ç–µ–π. –¢–æ–≥–¥–∞ –æ–¥–∏–Ω —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫ –∑–∞–π–º–µ—Ç <b>1/5</b> –ø–ª–æ—â–∞–¥–∏, –∞ –≤—Ç–æ—Ä–æ–π ‚Äî <b>4/5</b>."
            ],
            "default": [
                "\"–ú–µ—Ç–æ–¥ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π\" –∏–ª–∏ \"–º–µ—Ç–æ–¥ —á–∞—Å—Ç–µ–π\" ‚Äî —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Ç–∞–∫–∏—Ö –∑–∞–¥–∞—á.",
                "–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å—É–º–º–∞ –¥–≤—É—Ö –º–∞–ª–µ–Ω—å–∫–∏—Ö: <b>S(ABC) = S(ABD) + S(BCD)</b>.",
                "–ì–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è! –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–π, –∫–∞–∫–∞—è –ø–ª–æ—â–∞–¥—å –∫–∞–∫–æ–º—É –æ—Å–Ω–æ–≤–∞–Ω–∏—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç: <b>S(ABD)</b> —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç <b>AD</b>, –∞ <b>S(BCD)</b> ‚Äî <b>DC</b>."
            ]
        }
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 2.3: triangle_area_by_parallel_line
    # -------------------------------------------------------------------------
    "triangle_area_by_parallel_line": {
        "idea": "TODO: –ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–æ–±–Ω—ã—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤.",
        "steps_templates": [],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": []
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 2.4: triangle_area_by_midpoints
    # -------------------------------------------------------------------------
    "triangle_area_by_midpoints": {
        "idea": "TODO: –ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Å—Ä–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏.",
        "steps_templates": [],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": []
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 2.5: cosine_law_find_cos
    # -------------------------------------------------------------------------
    "cosine_law_find_cos": {
        "idea": "TODO: –ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–æ—Ä–µ–º—ã –∫–æ—Å–∏–Ω—É—Å–æ–≤.",
        "steps_templates": [],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": []
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 2.6: triangle_by_two_angles_and_side
    # -------------------------------------------------------------------------
    "triangle_by_two_angles_and_side": {
        "idea": "TODO: –ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–æ—Ä–µ–º—ã —Å–∏–Ω—É—Å–æ–≤.",
        "steps_templates": [],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": []
    }
}

# ---------------------------------------------------------------------------
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä)
# ---------------------------------------------------------------------------

def humanize(solution_core: List[Dict[str, Any]]) -> str:
    if not solution_core or not isinstance(solution_core, list):
        return "–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è."

    scenario_data = solution_core[0]
    full_action = scenario_data.get("action")
    context = scenario_data.get("data", {})

    pattern, narrative = (full_action.split(":", 1)) if ":" in full_action else (full_action, "default")

    scenario_group = TASK_15_SCENARIOS.get(pattern)
    if not scenario_group:
        return f"–®–∞–±–ª–æ–Ω —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ '{pattern}' –Ω–µ –Ω–∞–π–¥–µ–Ω."

    scenario = scenario_group.get("narratives", {}).get(narrative, scenario_group)
    if not scenario:
        return f"–°—Ü–µ–Ω–∞—Ä–∏–π '{narrative}' –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ '{pattern}' –Ω–µ –Ω–∞–π–¥–µ–Ω."

    parts = []

    # 1. –ò–¥–µ—è
    if "idea" in scenario:
        parts.append(f"üí° <b>–ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è:</b> {scenario['idea'].format(**context)}")

    # 2. –®–∞–≥–∏
    parts.append("ü™ú <b>–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ</b>")

    steps_html = []
    for step_template in scenario["steps_templates"]:
        processed_template = _apply_conditionals(step_template, context)
        try:
            rendered_step = processed_template.format(**context)
            steps_html.append(rendered_step)
        except KeyError as e:
            steps_html.append(f"<i>–û—à–∏–±–∫–∞ —à–∞–±–ª–æ–Ω–∞: –ø—Ä–æ–ø—É—â–µ–Ω –∫–ª—é—á {e}</i>")

    parts.append("\n\n".join(steps_html))

    # 3. –û—Ç–≤–µ—Ç
    if "answer_template" in scenario_group:
        parts.append(scenario_group["answer_template"].format(**context))

    # 4. –ü–æ–¥—Å–∫–∞–∑–∫–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–ê –õ–û–ì–ò–ö–ê)
    tips_key = scenario.get("tips_key", "default")
    if "tips" in scenario_group and tips_key in scenario_group["tips"]:
        formatted_tips = [tip.format(**context) for tip in scenario_group["tips"][tips_key]]
        tips_list = "\n".join(f"üîπ {t}" for t in formatted_tips)
        parts.append(f"‚ú® <b>–ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å</b>\n{tips_list}")

    return "\n\n".join(parts)
