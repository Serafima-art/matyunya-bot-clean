"""
–®–∞–±–ª–æ–Ω—ã –¥–ª—è –≥—É–º–∞–Ω–∏–∑–∞—Ü–∏–∏ —Ä–µ—à–µ–Ω–∏–π –ó–∞–¥–∞–Ω–∏—è 15 (–ü–ª–∞–Ω–∏–º–µ—Ç—Ä–∏—è).
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –°—Ü–µ–Ω–∞—Ä–∏–∏ (Narrative), –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è.
"""

from __future__ import annotations
from typing import Any, Dict, List

# =================================================================================================
# –ë–ò–ë–õ–ò–û–¢–ï–ö–ê –°–¶–ï–ù–ê–†–ò–ï–í
# =================================================================================================

TASK_15_SCENARIOS = {
    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 1.1: –í–Ω–µ—à–Ω–∏–π —É–≥–æ–ª
    # -------------------------------------------------------------------------
    "triangle_external_angle": {
        "idea": (
            "–û—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –∫–ª—é—á–µ–≤–æ–º —Å–≤–æ–π—Å—Ç–≤–µ –≤–Ω–µ—à–Ω–µ–≥–æ —É–≥–ª–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞.\n"
            "<b>–í–Ω–µ—à–Ω–∏–π —É–≥–æ–ª —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞ —Ä–∞–≤–µ–Ω —Å—É–º–º–µ –¥–≤—É—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤, –Ω–µ —Å–º–µ–∂–Ω—ã—Ö —Å –Ω–∏–º.</b>\n"
            "–≠—Ç–æ —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –∏ –ø—Ä—è–º–æ–π –ø—É—Ç—å –∫ –æ—Ç–≤–µ—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞ —ç–∫–∑–∞–º–µ–Ω–µ.\n"
            "–ï—Å—Ç—å –∏ –≤—Ç–æ—Ä–æ–π, –±–æ–ª–µ–µ –¥–ª–∏–Ω–Ω—ã–π, –Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏:\n"
            "–ù–∞–π—Ç–∏ —Ç—Ä–µ—Ç–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–≥–æ–ª: <b>‚à†{target_vertex} = 180¬∞ - (‚à†A + ‚à†B)</b>.\n"
            "–ù–∞–π—Ç–∏ —Å–º–µ–∂–Ω—ã–π —Å –Ω–∏–º –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª: –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = 180¬∞ - ‚à†{target_vertex}</b>."
        ),
        "steps_templates": [
            (
                "<b>–®–∞–≥ 1.</b> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:\n"
                "–í —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–µ <b>{triangle_name}</b> —É–≥–æ–ª <b>A</b> —Ä–∞–≤–µ–Ω <b>{angle_a_val}¬∞</b>, "
                "–∞ —É–≥–æ–ª <b>B</b> —Ä–∞–≤–µ–Ω <b>{angle_b_val}¬∞</b>. "
                "–ù–∞–π–¥–∏—Ç–µ –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª –ø—Ä–∏ –≤–µ—Ä—à–∏–Ω–µ <b>{target_vertex}</b>.\n"
                "–î–∞–Ω–æ: <b>‚à†A = {angle_a_val}¬∞, ‚à†B = {angle_b_val}¬∞</b>.\n"
                "–ù–∞–π—Ç–∏: –í–Ω–µ—à–Ω–∏–π —É–≥–æ–ª –ø—Ä–∏ –≤–µ—Ä—à–∏–Ω–µ <b>{target_vertex}</b>."
            ),
            (
                "<b>–®–∞–≥ 2.</b> –í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è –∫–ª—é—á–µ–≤—ã–º —Å–≤–æ–π—Å—Ç–≤–æ–º: –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª —Ä–∞–≤–µ–Ω —Å—É–º–º–µ –¥–≤—É—Ö –¥—Ä—É–≥–∏—Ö –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —É–≥–ª–æ–≤, –Ω–µ —Å–º–µ–∂–Ω—ã—Ö —Å –Ω–∏–º.\n"
                "‚û°Ô∏è –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = ‚à†A + ‚à†B</b>"
            ),
            (
                "<b>–®–∞–≥ 3.</b> –ü–æ–¥—Å—Ç–∞–≤–∏–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º—É–ª—É.\n"
                "‚û°Ô∏è –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = {angle_a_val}¬∞ + {angle_b_val}¬∞ = {res}¬∞</b>"
            ),
            (
                "<b>–®–∞–≥ 4.</b> (–°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞) –ü—Ä–æ–≤–µ—Ä–∏–º —Å–µ–±—è –≤—Ç–æ—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º.\n"
                "–ù–∞–π–¥–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —É–≥–æ–ª <b>{target_vertex}</b>: <b>‚à†{target_vertex} = 180¬∞ - ({angle_a_val}¬∞ + {angle_b_val}¬∞) = 180¬∞ - {res}¬∞ = {internal_c_val}¬∞</b>.\n"
                "–ù–∞–π–¥–µ–º –≤–Ω–µ—à–Ω–∏–π —É–≥–æ–ª –ø—Ä–∏ <b>{target_vertex}</b>, –∫–æ—Ç–æ—Ä—ã–π —Å–º–µ–∂–µ–Ω —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º: –í–Ω–µ—à–Ω–∏–π <b>‚à†{target_vertex} = 180¬∞ - {internal_c_val}¬∞ = {res}¬∞</b>.\n"
                "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–≤–ø–∞–ª–∏, —Ä–µ—à–µ–Ω–∏–µ –≤–µ—Ä–Ω–æ–µ."
            )
        ],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": [
            "–ó–∞–ø–æ–º–Ω–∏ –≥–ª–∞–≤–Ω—É—é —Ñ–æ—Ä–º—É–ª—É ‚Äî —ç—Ç–æ —Å–∞–º—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –ø—É—Ç—å. –ù–∞ —ç–∫–∑–∞–º–µ–Ω–µ –≤–∞–∂–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å.",
            "–í—Å–µ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π —Å—Ö–µ–º–∞—Ç–∏—á–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Ç–∞—Ç—å—Å—è, –∫–∞–∫–∏–µ —É–≥–ª—ã —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å.",
            "–í –æ—Ç–≤–µ—Ç –ø—Ä–æ—Å—è—Ç —á–∏—Å–ª–æ –±–µ–∑ –∑–Ω–∞–∫–∞ –≥—Ä–∞–¥—É—Å–∞. –ü—Ä–æ—Å—Ç–æ <b>{res}</b>.",
            "–°–≤–æ–π—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞."
        ]
    },

    # -------------------------------------------------------------------------
    # –ü–ê–¢–¢–ï–†–ù 1.2: –ë–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞
    # -------------------------------------------------------------------------
    "angle_bisector_find_half_angle": {
        "idea": (
            "–ó–∞–¥–∞—á–∞-–ª–æ–≤—É—à–∫–∞ –Ω–∞ –∑–Ω–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞. –í—Å—ë —Ä–µ—à–µ–Ω–∏–µ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏:\n"
            "<b>–ë–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ ‚Äî —ç—Ç–æ –ª—É—á, –∫–æ—Ç–æ—Ä—ã–π –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –≤–µ—Ä—à–∏–Ω—ã —É–≥–ª–∞ –∏ –¥–µ–ª–∏—Ç –µ–≥–æ –Ω–∞ –¥–≤–∞ —Ä–∞–≤–Ω—ã—Ö —É–≥–ª–∞.</b>\n"
            "–¢–æ –µ—Å—Ç—å, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —É–≥–æ–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–∑—É–µ—Ç –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω–æ–π, –Ω—É–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —É–≥–æ–ª –Ω–∞ 2."
        ),
        "steps_templates": [
            (
                "<b>–®–∞–≥ 1.</b> –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —É—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:\n"
                "–í —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–µ <b>{triangle_name}</b> –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ <b>{full_angle_name} = {full_angle_val}¬∞</b>, "
                "<b>{bisector_name}</b> ‚Äî –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞. –ù–∞–π–¥–∏—Ç–µ —É–≥–æ–ª <b>{target_half_name}</b>.\n"
                "–î–∞–Ω–æ: <b>{full_angle_name} = {full_angle_val}¬∞</b>.\n"
                "–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: <b>{bisector_name}</b> ‚Äî –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞.\n"
                "–ù–∞–π—Ç–∏: <b>{target_half_name}</b>."
            ),
            (
                "<b>–®–∞–≥ 2.</b> –í—Å–ø–æ–º–Ω–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å—ã.\n"
                "–†–∞–∑ <b>{bisector_name}</b> ‚Äî –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ —É–≥–ª–∞ <b>{full_angle_name}</b>, –æ–Ω–∞ –¥–µ–ª–∏—Ç –µ–≥–æ –Ω–∞ –¥–≤–∞ —Ä–∞–≤–Ω—ã—Ö —É–≥–ª–∞: "
                "<b>{target_half_name}</b> –∏ <b>{second_half_name}</b>.\n"
                "‚û°Ô∏è <b>{target_half_name} = {second_half_name} = {full_angle_name} / 2</b>"
            ),
            (
                "<b>–®–∞–≥ 3.</b> –ü–æ–¥—Å—Ç–∞–≤–∏–º –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ.\n"
                "‚û°Ô∏è <b>{target_half_name} = {full_angle_val}¬∞ / 2 = {res}¬∞</b>"
            )
        ],
        "answer_template": "üéØ –û—Ç–≤–µ—Ç: <b>{res}</b>",
        "tips": [
            "–ö–ª—é—á –∫ –∑–∞–¥–∞—á–µ ‚Äî —Å–ª–æ–≤–æ \"–±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞\". –ï—Å–ª–∏ —Ç—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ –æ–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç, –∑–∞–¥–∞—á–∞ —Ä–µ—à–∞–µ—Ç—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥.",
            "–¢—Ä–∏ –≥–ª–∞–≤–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ –ø–ª–∞–Ω–∏–º–µ—Ç—Ä–∏–∏: –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å–∞ (–¥–µ–ª–∏—Ç —É–≥–æ–ª –ø–æ–ø–æ–ª–∞–º), –º–µ–¥–∏–∞–Ω–∞ (–¥–µ–ª–∏—Ç –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É –ø–æ–ø–æ–ª–∞–º), –≤—ã—Å–æ—Ç–∞ (–ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä–Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ). –ù–µ –ø—É—Ç–∞–π –∏—Ö!",
            "–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π, –∫–∞–∫–æ–π –∏–∑ –¥–≤—É—Ö –ø–æ–ª–æ–≤–∏–Ω—á–∞—Ç—ã—Ö —É–≥–ª–æ–≤ –ø—Ä–æ—Å—è—Ç –Ω–∞–π—Ç–∏. –í —Å–ª—É—á–∞–µ –±–∏—Å—Å–µ–∫—Ç—Ä–∏—Å—ã –æ–Ω–∏ —Ä–∞–≤–Ω—ã, –Ω–æ –≤ –¥—Ä—É–≥–∏—Ö –∑–∞–¥–∞—á–∞—Ö —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–∂–Ω–æ."
        ]
    }
}

# ---------------------------------------------------------------------------
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–µ—Ä)
# ---------------------------------------------------------------------------

def humanize(solution_core: List[Dict[str, Any]]) -> str:
    if not solution_core or not isinstance(solution_core, list):
        return "–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ—à–µ–Ω–∏—è."

    scenario_data = solution_core[0]
    pattern = scenario_data.get("action")
    context = scenario_data.get("data", {})

    scenario = TASK_15_SCENARIOS.get(pattern)
    if not scenario:
        return f"–®–∞–±–ª–æ–Ω —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ '{pattern}' –Ω–µ –Ω–∞–π–¥–µ–Ω."

    parts = []

    # 1. –ò–¥–µ—è
    if "idea" in scenario:
        parts.append(f"üí° <b>–ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è:</b> {scenario['idea'].format(**context)}")

    # 2. –®–∞–≥–∏
    parts.append("ü™ú <b>–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ</b>")

    steps_html = []
    for step_template in scenario["steps_templates"]:
        try:
            rendered_step = step_template.format(**context)
            steps_html.append(rendered_step)
        except KeyError as e:
            steps_html.append(f"<i>–û—à–∏–±–∫–∞ —à–∞–±–ª–æ–Ω–∞: –ø—Ä–æ–ø—É—â–µ–Ω –∫–ª—é—á {e}</i>")

    parts.append("\n\n".join(steps_html))

    # 3. –û—Ç–≤–µ—Ç
    if "answer_template" in scenario:
        parts.append(scenario["answer_template"].format(**context))

    # 4. –ü–æ–¥—Å–∫–∞–∑–∫–∏
    if "tips" in scenario and scenario["tips"]:
        # –ö–∞–∂–¥—ã–π tip —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –≤ –Ω–∏—Ö —Ç–æ–∂–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        formatted_tips = [tip.format(**context) for tip in scenario["tips"]]
        tips_list = "\n".join(f"üîπ {t}" for t in formatted_tips)
        parts.append(f"‚ú® <b>–ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å</b>\n{tips_list}")

    return "\n\n".join(parts)
