"""Humanizer for Task 8: Formats solution data into HTML (Strict Layout)."""

from __future__ import annotations

from typing import Any, Dict, Iterable, List

# ============================================================================
# 1. –®–ê–ë–õ–û–ù–´ –ò–î–ï–ô (IDEA_TEMPLATES)
# ============================================================================
IDEA_TEMPLATES: Dict[str, str] = {
    "IDEA_ALG_POWER_FRACTION": (
        "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–≤–æ–¥–∏–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∫ —Å–∞–º–æ–π –ø—Ä–æ—Å—Ç–æ–π —Å—Ç–µ–ø–µ–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π\n"
        "<b>a·µê ¬∑ a‚Åø = a·µê‚Å∫‚Åø</b>\n"
        "<b>(a·µê)‚Åø = a·µê‚Åø</b>\n"
        "<b>(a ¬∑ b)‚Åø = a‚Åø ¬∑ b‚Åø</b>\n"
        "<b>a·µê : a‚Åø = a·µê‚Åª‚Åø</b>\n"
        "<b>a‚Åª‚Åø = 1 / a‚Åø</b>\n"
        "–ê —É–∂–µ –ø–æ—Ç–æ–º –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç."
    ),
    "IDEA_ALG_RADICAL_POWER": (
        "–°–Ω–∞—á–∞–ª–∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —É–ø—Ä–æ—â–∞–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ –∫–æ—Ä–Ω–µ–º, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π:\n"
        "<b>a·µê : a‚Åø = a·µê‚Åª‚Åø</b>\n"
        "<b>a·µê ¬∑ a‚Åø = a·µê‚Å∫‚Åø</b>\n"
        "<b>(a·µê)‚Åø = a·µê‚Åø</b>\n"
        "<b>‚àö(k ¬∑ a‚Åø) = ‚àök ¬∑ ‚àöa‚Åø = ‚àök ¬∑ a‚Åø·êü¬≤</b> (–≥–¥–µ <b>n/2</b> ‚Äî –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Å—Ç–µ–ø–µ–Ω–∏)\n"
        "–ö–æ–≥–¥–∞ –ø–æ–¥–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ, —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π."
    ),
    "IDEA_ALG_RADICAL_FRACTION": (
        "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–æ–±—Ä–∞–∑—É–π –∫–æ—Ä–Ω–∏ –≤ —á–∏—Å–ª–∏—Ç–µ–ª–µ (–∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–µ), –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π—Å—Ç–≤–∞ –∫–æ—Ä–Ω–µ–π:\n"
        "<b>‚àö(ab) = ‚àöa ¬∑ ‚àöb</b>\n"
        "<b>‚àö(a / b) = ‚àöa / ‚àöb</b>\n"
        "–ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —É–ø—Ä–æ—Å—Ç–∏ –ø–æ–¥–∫–æ—Ä–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (—Å–æ–∫—Ä–∞—â–∞–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –≤—ã–Ω–æ—Å–∏ —Å—Ç–µ–ø–µ–Ω–∏),\n"
        "–∞ —É–∂–µ –ø–æ—Ç–æ–º –∏–∑–≤–ª–µ–∫–∞–π –∫–æ—Ä–Ω–∏ –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–π –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö."
    ),
    "IDEA_GENERIC": "–†–µ—à–∞–µ–º –∑–∞–¥–∞—á—É, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—â–∞—è –≤—ã—Ä–∞–∂–µ–Ω–∏–µ.",
}

# ============================================================================
# 2. –®–ê–ë–õ–û–ù–´ –®–ê–ì–û–í (STEP_TEMPLATES)
# ============================================================================
STEP_TEMPLATES: Dict[str, str] = {
    # --- –û–±—â–∏–µ ---
    "STEP_INITIAL": "–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∏—Å—Ö–æ–¥–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ\n<b>{expr}</b> –ø—Ä–∏ {vars}",
    "STEP_INITIAL_NO_VARS": "–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∏—Å—Ö–æ–¥–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ\n<b>{expr}</b>",
    "STEP_SUBSTITUTE_AND_CALC": "–ü–æ–¥—Å—Ç–∞–≤–∏–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ –∏—Ç–æ–≥–æ–≤–æ–µ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Å–ª–∏–º, <b>{vars}</b>",
    "STEP_SUBSTITUTE_FINAL": "–ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, <b>{vars}</b>",
    "STEP_CONVERT_TO_DECIMAL": "–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥—Ä–æ–±—å <b>{frac}</b> –≤ –¥–µ—Å—è—Ç–∏—á–Ω—É—é, –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç –û–ì–≠",
    "STEP_WRITE_ANSWER": "–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç",

    # --- alg_power_fraction ---
    "STEP_SIMPLIFY_NUMERATOR": "–£–ø—Ä–æ—Å—Ç–∏–º —á–∏—Å–ª–∏—Ç–µ–ª—å <b>{expr}</b>, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π",
    "STEP_DIVIDE_POWERS": "–†–∞–∑–¥–µ–ª–∏–º —á–∏—Å–ª–∏—Ç–µ–ª—å –Ω–∞ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å, –ø—Ä–∏–º–µ–Ω—è—è —Å–≤–æ–π—Å—Ç–≤–æ –¥–µ–ª–µ–Ω–∏—è —Å—Ç–µ–ø–µ–Ω–µ–π",

    # --- alg_radical_power ---
    "STEP_SIMPLIFY_RADICAND_FRACTION": "–£–ø—Ä–æ—Å—Ç–∏–º –¥—Ä–æ–±—å –ø–æ–¥ –∫–æ—Ä–Ω–µ–º, –ø—Ä–∏–º–µ–Ω—è—è —Å–≤–æ–π—Å—Ç–≤–æ –¥–µ–ª–µ–Ω–∏—è —Å—Ç–µ–ø–µ–Ω–µ–π",
    "STEP_SIMPLIFY_RADICAND_PRODUCT": "–£–ø—Ä–æ—Å—Ç–∏–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ –∫–æ—Ä–Ω–µ–º, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π—Å—Ç–≤–∞ —Å—Ç–µ–ø–µ–Ω–µ–π",
    "STEP_RADICAND_ALREADY_SIMPLE": "–í—ã—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ –∫–æ—Ä–Ω–µ–º —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–æ.",
    "STEP_SUBSTITUTE_INTO_ROOT": "–ü–æ–¥—Å—Ç–∞–≤–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –ø–æ–¥ –∫–æ—Ä–µ–Ω—å",
    "STEP_EXTRACT_ROOT": "–ò–∑–≤–ª–µ—á—ë–º –∫–æ—Ä–µ–Ω—å, –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–π—Å—Ç–≤–æ ‚àö(k ¬∑ a‚Åø) = ‚àök ¬∑ ‚àöa‚Åø",

    # --- alg_radical_fraction (–ù–û–í–´–ï) ---
    "STEP_TRANSFORM_NUMERATOR": "–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º (—É–ø—Ä–æ—Å—Ç–∏–º) —á–∏—Å–ª–∏—Ç–µ–ª—å, —Ä–∞–∑–ª–æ–∂–∏–≤ –∫–æ—Ä–Ω–∏ –Ω–∞ –º–Ω–æ–∂–∏—Ç–µ–ª–∏.",
    "STEP_TRANSFORM_DENOMINATOR": "–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º (—É–ø—Ä–æ—Å—Ç–∏–º) –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å, —Ä–∞–∑–ª–æ–∂–∏–≤ –∫–æ—Ä–Ω–∏ –Ω–∞ –º–Ω–æ–∂–∏—Ç–µ–ª–∏.",
    "STEP_SUBSTITUTE_INTO_FRACTION": "–ü–æ–¥—Å—Ç–∞–≤–∏–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π {part} –≤ –∏—Å—Ö–æ–¥–Ω—É—é –¥—Ä–æ–±—å",
    "STEP_REDUCE_ROOTS": "–í–∏–¥–∏–º, —á—Ç–æ –∏ —á–∏—Å–ª–∏—Ç–µ–ª—å, –∏ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å –º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –Ω–∞ <b>{term}</b>",
}

# ============================================================================
# 3. –®–ê–ë–õ–û–ù–´ –¢–ï–û–†–ò–ò (KNOWLEDGE_TEMPLATES)
# ============================================================================
KNOWLEDGE_TEMPLATES: Dict[str, List[str]] = {
    "KNOWLEDGE_ALG_POWER_FRACTION": [
        "üîπ\"–ú–∞—Ç—Ä–µ—à–∫–∞\" (—Å—Ç–µ–ø–µ–Ω—å –≤ —Å—Ç–µ–ø–µ–Ω–∏) ‚Äî –ø–µ—Ä–µ–º–Ω–æ–∂–∞–µ–º —Å—Ç–µ–ø–µ–Ω–∏\n"
        "–ï—Å–ª–∏ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ:\n"
        "‚Äî –ø—Ä–∏ —É–º–Ω–æ–∂–µ–Ω–∏–∏ —Å—Ç–µ–ø–µ–Ω–∏ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º: <b>a·µê ¬∑ a‚Åø = a·µê‚Å∫‚Åø</b>\n"
        "‚Äî –ø—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ –≤—ã—á–∏—Ç–∞–µ–º: <b>a·µê : a‚Åø = a·µê‚Åª‚Åø</b>",
        "üîπ–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å - —ç—Ç–æ –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–Ω–∞–∫ ¬´–ø–µ—Ä–µ–º–µ—Å—Ç–∏ –º–µ–Ω—è –≤ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å¬ª –∏ –≤—Å–µ–≥–¥–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –¥—Ä–æ–±—å:\n"
        "<b>a‚Åª‚Åø = 1 / a‚Åø</b>",
        "üîπ–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É–ø—Ä–æ—â–µ–Ω–∏—è –≤—Å–µ—Ö —Å—Ç–µ–ø–µ–Ω–µ–π."
    ],
    "KNOWLEDGE_ALG_RADICAL_POWER": [
        "üîπ–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –∏–∑–≤–ª–µ–∫–∞—Ç—å –∫–æ—Ä–µ–Ω—å, –≤—Å–µ–≥–¥–∞ –Ω–∞–≤–µ–¥–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ ¬´–≥–µ–Ω–µ—Ä–∞–ª—å–Ω—É—é —É–±–æ—Ä–∫—É¬ª: —Å–æ–∫—Ä–∞—Ç–∏ —Å—Ç–µ–ø–µ–Ω–∏ –∏ —É–ø—Ä–æ—Å—Ç–∏ –¥—Ä–æ–±—å.",
        "üîπ–ö–æ—Ä–µ–Ω—å –∏–∑ —Å—Ç–µ–ø–µ–Ω–∏ ‚Äî —ç—Ç–æ –ø–æ–ª–æ–≤–∏–Ω–∫–∞ —Å—Ç–µ–ø–µ–Ω–∏ <b>‚àö(a‚Åø) = a‚Åø·êü¬≤</b>",
        "üîπ–ö–æ—Ä–µ–Ω—å –º–æ–∂–Ω–æ ¬´—Ä–∞–∑–±–∏—Ç—å¬ª <b>‚àö(k ¬∑ a‚Åø) = ‚àök ¬∑ ‚àöa‚Åø = ‚àök ¬∑a‚Åø·êü¬≤</b>. –ò —ç—Ç–æ –æ—á–µ–Ω—å —É—Å–∫–æ—Ä—è–µ—Ç —Ä–µ—à–µ–Ω–∏–µ.",
        "üîπ–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É–ø—Ä–æ—â–µ–Ω–∏—è, —á—Ç–æ–±—ã —Å—á–∏—Ç–∞—Ç—å –±—ã–ª–æ –ø—Ä–æ—â–µ –∏ –±–µ–∑ –æ—à–∏–±–æ–∫."
    ],
    "KNOWLEDGE_ALG_RADICAL_FRACTION": [
        "üîπ –ß–∞—Å—Ç–æ —É–¥–æ–±–Ω–æ —Å–Ω–∞—á–∞–ª–∞ ¬´–≤—ã—Ç–∞—â–∏—Ç—å¬ª –∏–∑-–ø–æ–¥ –∫–æ—Ä–Ω—è –≤—Å—ë, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–º –∫–≤–∞–¥—Ä–∞—Ç–æ–º",
        "üîπ –ï—Å–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ—Ä–µ–Ω—å –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ —á–∏—Å–ª–∏—Ç–µ–ª–µ –∏ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª–µ ‚Äî –∏—Ö –º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å, –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏.",
        "üîπ –ï—Å–ª–∏ –ø–æ—Å–ª–µ —É–ø—Ä–æ—â–µ–Ω–∏—è –∫–∞–∫–∞—è-—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏—Å—á–µ–∑–ª–∞ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –∑–Ω–∞—á–∏—Ç –æ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–∫—Ä–∞—Ç–∏–ª–∞—Å—å.",
        "üîπ –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫—É —á–∏—Å–ª–∞ –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, –∫–æ–≥–¥–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ —É–ø—Ä–æ—Å—Ç–∏–ª–æ—Å—å."
    ]
}

# ============================================================================
# 4. –®–ê–ë–õ–û–ù–´ –í–ù–ò–ú–ê–ù–ò–Ø (ATTENTION_TEMPLATES)
# ============================================================================
ATTENTION_TEMPLATES: Dict[str, List[str]] = {
    "ATTENTION_ALG_RADICAL_FRACTION_VAR_GONE": [
        "–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è <b>{var}</b> –∏—Å—á–µ–∑–ª–∞ –∏–∑ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–∫—Ä–∞—Ç–∏–ª–∞—Å—å –Ω–∞ —à–∞–≥–µ 4.",
        "–ü–æ—ç—Ç–æ–º—É –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å <b>{var}</b> –Ω–µ–∫—É–¥–∞ ‚Äî —ç—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤ —Ñ–æ—Ä–º—É–ª–µ."
    ]
}


# ============================================================================
# MAIN RENDERER
# ============================================================================

def humanize(solution_core: Dict[str, Any]) -> str:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è. –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç solution_core –≤ HTML.
    """
    parts: List[str] = []

    # 1. –ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è
    idea_key = solution_core.get("explanation_idea_key")
    idea_text = ""
    if idea_key:
        idea_text = IDEA_TEMPLATES.get(idea_key, IDEA_TEMPLATES["IDEA_GENERIC"])
    else:
        idea_text = str(solution_core.get("explanation_idea") or "")

    if idea_text:
        parts.append(f"üí° <b>–ò–¥–µ—è —Ä–µ—à–µ–Ω–∏—è: </b>{idea_text}")
        parts.append("")

    # 2. –®–∞–≥–∏
    steps = solution_core.get("calculation_steps") or []
    if steps:
        parts.append("ü™ú <b>–ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ</b>")
        parts.append("")
        for step in steps:
            parts.append(_render_step(step))
            parts.append("")

    # 3. –û—Ç–≤–µ—Ç
    final_answer_val = str((solution_core.get("final_answer") or {}).get("value_display", ""))
    if final_answer_val:
        parts.append(f"üéØ–û—Ç–≤–µ—Ç: <b>{final_answer_val}</b>")
        parts.append("")

    # 4. –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ (Attention)
    attention_key = solution_core.get("attention_tips_key")
    attention_params = solution_core.get("attention_tips_params") or {}
    attention_items = []

    if attention_key:
        raw_items = ATTENTION_TEMPLATES.get(attention_key, [])
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, {var})
        for item in raw_items:
            try:
                attention_items.append(item.format(**attention_params))
            except KeyError:
                attention_items.append(item)
    else:
        attention_items = _extract_list(solution_core.get("attention_tips"))

    if attention_items:
        parts.append(_render_attention_block(attention_items))
        parts.append("")

    # 5. –ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å (Knowledge)
    knowledge_key = solution_core.get("knowledge_tips_key")
    knowledge_items = []

    if knowledge_key:
        knowledge_items = KNOWLEDGE_TEMPLATES.get(knowledge_key, [])
    else:
        knowledge_items = _extract_list(solution_core.get("knowledge_tips"))

    if knowledge_items:
        parts.append(_render_knowledge_block(knowledge_items))

    return "\n".join(parts).strip()


# ============================================================================
# HELPERS
# ============================================================================

def _render_step(step: Dict[str, Any]) -> str:
    number = step.get("step_number", "")

    desc_key = step.get("description_key")
    params = step.get("description_params") or {}

    description = ""
    if desc_key and desc_key in STEP_TEMPLATES:
        try:
            description = STEP_TEMPLATES[desc_key].format(**params)
        except KeyError as e:
            description = f"{desc_key} (–æ—à–∏–±–∫–∞ —à–∞–±–ª–æ–Ω–∞: {e})"
    else:
        description = str(step.get("description") or "")

    formula = step.get("formula_calculation")

    lines = [f"<b>–®–∞–≥ {number}.</b> {description}"]
    if formula:
        if "\n" in formula:
             f_lines = formula.split("\n")
             for fl in f_lines:
                 if fl.strip():
                     lines.append(f"‚û°Ô∏è <b>{fl}</b>")
        else:
            lines.append(f"‚û°Ô∏è <b>{formula}</b>")

    return "\n".join(lines)


def _render_attention_block(tips: Iterable[str]) -> str:
    # –í –º–∞–∫–µ—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å —ç–º–æ–¥–∑–∏, –Ω–æ –±–µ–∑ –∂–∏—Ä–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞
    lines = ["‚ú® –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ:"]
    for tip in tips:
        # –í –º–∞–∫–µ—Ç–µ –±–µ–∑ –±—É–ª–ª–∏—Ç–æ–≤, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
        lines.append(str(tip))
    return "\n".join(lines)


def _render_knowledge_block(tips: Iterable[str]) -> str:
    lines = ["‚ú® –ü–æ–ª–µ–∑–Ω–æ –∑–Ω–∞—Ç—å", "<tg-spoiler>"]
    for tip in tips:
        lines.append(str(tip))
    lines.append("</tg-spoiler>")
    return "\n".join(lines)


def _extract_list(value: Any) -> List[str]:
    if isinstance(value, list) and value:
        return [str(item) for item in value if item]
    return []
