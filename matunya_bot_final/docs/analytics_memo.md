Памятка-Чек-лист: Архитектура Аналитики "Матюня"
Проект: Телеграм-бот "Матюня"
Задача: Создание системы сбора и анализа статистики прогресса учеников.
1. Философия и Цели:
Двойная Ценность: Система должна предоставлять ценность двум разным аудиториям.
Для Ученика: "Честное Зеркало". Предоставление "жёсткой", объективной статистики в цифрах для самоанализа и выявления слабых мест.
Для Родителя: "Дайджест Поддержки". Предоставление "мягкой", интерпретированной информации с психологическими советами по поддержке ребенка, а не для контроля.
Принцип: Мы собираем одни и те же данные, но представляем их в двух разных форматах.
2. Технический Стек (Инструменты):
База Данных: SQLite (на старте, для простоты), с возможностью миграции на PostgreSQL в будущем.
Взаимодействие с БД: Никакого "голого" SQL в хендлерах. Вся работа с базой ведется через ORM SQLAlchemy (в асинхронном режиме).
Изменение Структуры БД: Только через систему миграций (Alembic).
3. Архитектура Хранилища (Структура):
Модуль utils/db_manager.py: Единственная "точка входа" для всей бизнес-логики для работы с базой данных. Хендлеры вызывают только функции из этого модуля.
Модуль utils/models.py: Описание всех таблиц базы данных в виде Python-классов (моделей SQLAlchemy).
4. Структура Данных (Таблицы):
Таблица users: Хранит информацию о пользователях (учениках и родителях).
Ключевые поля: id, telegram_id, name, parent_telegram_id.
Таблица tasks: Наша статичная, проверенная база задач.
Ключевые поля: id, public_id, theme, text, answer.
Таблица answer_logs: "Сердце" всей системы. Журнал каждой попытки ответа.
Ключевые поля: user_id, task_id, is_correct, time_spent, help_used, timestamp.
5. План Реализации (Пошаговый):
Шаг 1 (Фундамент): Инициализация БД и создание "скелета" таблиц. (✅ СДЕЛАНО)
Шаг 2 (Регистрация): Реализация функции add_user и ее вызов в start_handler.
Шаг 3 (Прием Ответа): Создание хендлера для приема ответов ученика, который вызывает log_answer для записи данных в answer_logs.
Шаг 4 (Дашборд Ученика): Создание функции в db_manager для расчета "жёсткой" статистики и хендлера для ее отображения.
Шаг 5 (Дайджест Родителя): Создание функции для генерации "мягкой" интерпретации и хендлера для ее еженедельной отправки.

Контрольные Вопросы ("Компас Матюни")
1. Вопрос о Ценности:
Мы сейчас решаем проблему ученика или проблему родителя? Как наше текущее действие помогает ученику снять тревогу и почувствовать контроль, а родителю — получить уверенность и стать союзником?
2. Вопрос об Игровой Механике (Анти-Кринж):
Та фича, которую мы обсуждаем, — это "умный инструмент" или "кринжовая игра"? Не пытаемся ли мы сейчас притвориться тем, кем не являемся? Соответствует ли это философии "честного помощника"?
3. Вопрос о Данных (Два Зеркала):
Те данные, которые мы сейчас собираем/обрабатываем, как они будут выглядеть в "жёстком зеркале" для ученика (честные цифры, actionable) и в "мягком зеркале" для родителя (интерпретация, советы по поддержке)?
4. Вопрос о Технической Архитектуре (Гибкость):
То решение, которое мы сейчас внедряем, соответствует ли оно нашим трем принципам: "Нормализация" (разделение сущностей), "Абстракция" (логика в db_manager, а не в хендлерах) и "Миграции" (безопасное изменение структуры)?
5. Вопрос о Токсичности (Главный Анти-Паттерн):
Не нарушает ли наша новая фича один из "Пяти Смертных Грехов"? Не является ли она "душной", "токсичной", "жадной" или "вторгающейся в личное пространство"?

Памятка: "Пять Смертных Грехов Анти-Матюни"
(Наша "Карта Минных Полей")
Это фундаментальные "красные флаги", которые мы обязаны избегать любой ценой, чтобы наш продукт не оттолкнул, а привлек нашу целевую аудиторию.
1. Грех "Душнины" (Неуважение ко Времени и Интеллекту)
Проявления: Принудительный гринд, искусственные таймеры и ограничения ("энергия", "жизни"), непропускаемые туториалы, наказания за неактивность.
Заповедь: "Уважай время и интеллект пользователя". Каждая сессия должна быть короткой, динамичной и приносить ощутимую пользу.
2. Грех "Кринжа" (Фальшивая Попытка "Быть Своим")
Проявления: Устаревший или неуместный сленг, "детские" сюжеты и персонажи (единороги, принцессы), панибратский тон, попытки быть "в тренде", которые выглядят фальшиво.
Заповедь: "Будь аутентичным и честным". Лучше быть качественным инструментом, чем плохой пародией на игру. Наш тон — уважительный, прямой, без заигрываний.
3. Грех "Токсичности" (Неуважение к Чувствам)
Проявления: Пассивная агрессия, шейминг ("Вася решил больше тебя"), манипуляция чувством вины ("Без тебя Матюня грустит"), чрезмерный и фальшивый позитив ("Ты — супер-гений!").
Заповедь: "Поддерживай, а не оценивай". Обратная связь должна быть конструктивной и нейтральной. Эмоциональная поддержка — только по запросу и очень тактично.
4. Грех "Жадности" (Несправедливая Монетизация)
Проявления: Pay-to-Win (покупка игрового преимущества), Paywall (скрытие основного контента за оплатой), манипулятивные механики (лутбоксы), непрозрачная экономика.
Заповедь: "Монетизируй удобство, а не преимущество". Основной функционал должен быть бесплатным. Платными могут быть только дополнительные сервисы (аналитика для родителей) или "косметика", не влияющая на результат.
5. Грех "Вторжения" (Нарушение Личных Границ)
Проявления: Запрос ненужных личных данных, "стукачество" родителям, автоматический постинг в соцсети, спам-уведомления, навязчивая "дружба".
Заповедь: "Соблюдай приватность и дай контроль". Все социальные взаимодействия и уведомления — только по инициативе и с явного согласия пользователя.

Наш План Миграции с TinyDB на SQLAlchemy
Инвентаризация: Мы должны составить список всех хендлеров в проекте, которые сейчас читают или пишут данные в TinyDB.
Приоритизация: Мы начнем с самых важных хендлеров — тех, что отвечают за обработку ответов и запись прогресса.
Поэтапный Рефакторинг: Мы будем брать по одному хендлеру за раз и выполнять в нем две операции:
Убирать код, работающий с TinyDB.
Добавлять код, работающий с SQLAlchemy через наш db_manager.
Финальная Зачистка: Когда в списке не останется ни одного хендлера, использующего TinyDB, мы сможем полностью удалить эту библиотеку из проекта и из requirements.txt.