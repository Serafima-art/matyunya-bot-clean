# Документация: Система Управления Сообщениями ("Интеллектуальная Уборка")

**Файл:** `utils/message_manager.py`
**Версия:** 1.0
**Дата:** 18.09.2025

## 1. Философия и Назначение

Система Управления Сообщениями (Message Manager) — это центральный узел, отвечающий за отправку, отслеживание и удаление сообщений в боте. Она была создана для решения ключевой проблемы Telegram-ботов: управления "мусором" в чате и создания чистого, динамического пользовательского интерфейса без "мерцания".

**Главный принцип:** Ни одно сообщение, которое может потребовать последующего управления (удаления или редактирования), не должно отправляться напрямую через `bot.send_message()`. Вместо этого используется специальный "умный" отправщик.

## 2. Архитектура "Контейнеры Памяти"

В основе системы лежит простая, но мощная архитектура, хранящаяся в "памяти" пользователя (`FSMContext` / `state`).

### Компонент №1: "Общий Склад" (`tracked_messages`)
- **Тип:** Словарь (`dict`).
- **Назначение:** Хранит **все** отслеживаемые `message_id` для текущей сессии.
- **Структура:** `{ "именная_бирка_1": 12345, "именная_бирка_2": 12346, ... }`
- **Аналогия:** Большой склад, где на каждой полке (бирка) лежит коробка с известным инвентарным номером (`message_id`).

### Компонент №2: "Контейнеры" (`message_tags_by_category`)
- **Тип:** Словарь, значениями которого являются списки (`dict[str, list]`).
- **Назначение:** Группирует "именные бирки" по логическим категориям.
- **Структура:**
  ```json
  {
    "tasks": ["overview_text_1", "task_image_2"],
    "menus": ["overview_keyboard_123"],
    "dialog_messages": ["ask_question_prompt", "gpt_answer_1"]
  }
Аналогия: Разные комнаты на складе ("Задачи", "Меню", "Диалоги"). В каждой комнате лежит список полок (бирок), которые к ней относятся.
3. Основные Функции ("Инструменты")
send_tracked_message() / send_tracked_photo()
Назначение: Единственный правильный способ отправлять управляемые сообщения.
Ключевые аргументы:
message_tag: str: "Именная Бирка". Уникальное имя для конкретного сообщения.
category: str: "Имя Контейнера". Название группы, к которой относится сообщение.
Что делают под капотом:
Отправляют сообщение/фото в Telegram.
Получают message_id.
Записывают пару (message_tag, message_id) на "Общий Склад" (tracked_messages).
Добавляют message_tag в список нужного "Контейнера" (message_tags_by_category).
cleanup_messages_by_category()
Назначение: "Точечная уборка". Удаляет целую группу сообщений.
Ключевые аргументы:
category: str: Имя "контейнера", который нужно очистить (например, "dialog_messages").
message_tag: str (опционально): Если указан, удаляет только одно сообщение с конкретной биркой внутри категории.
Что делает под капотом:
Находит "контейнер" по имени.
Берет из него список "бирок".
Для каждой "бирки" находит message_id на "Складе".
Вызывает bot.delete_message() для каждого найденного message_id.
Чистит за собой: удаляет использованные "бирки" и записи со "Склада".
cleanup_all_messages()
Назначение: "Генеральная уборка".
Что делает: Проходится по всему "Складу" tracked_messages, удаляет все отслеживаемые сообщения и полностью очищает "Склад" и все "Контейнеры". Идеально подходит для использования при выходе в главное меню или старте новой сессии.
4. Пример Использования (Жизненный Цикл)
Отправка: Хендлер вызывает send_tracked_message(..., message_tag="task_5_text", category="tasks").
Память: В state появляются записи:
tracked_messages: { "task_5_text": 12345 }
message_tags_by_category: { "tasks": ["task_5_text"] }
Смена контекста: Пользователь решает задачу и переходит к следующей.
Уборка: Другой хендлер вызывает cleanup_messages_by_category(..., category="tasks").
Результат: Сообщение с message_id=12345 удаляется из чата, а все связанные записи стираются из state, поддерживая чистоту и порядок.