from aiogram import Router
from aiogram.types import Message
from aiogram.fsm.context import FSMContext

#from states.user_states import TaskState
#from utils.answer_check import answers_equal

router = Router(name="user_answer")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ (Ğ¿Ğ¾ĞºĞ° Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°, Ğ½Ğ¾ ÑƒĞ¶Ğµ Ğ½Ğ° ÑĞ²Ğ¾ĞµĞ¼ Ğ¼ĞµÑÑ‚Ğµ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def save_stats(state: FSMContext, is_correct: bool):
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ² ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ ÑƒÑ‡ĞµĞ½Ğ¸ĞºĞ°."""
    # TODO: Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² "ĞœĞ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ"
    # data = await state.get_data()
    # task_type = data.get("task_type")
    # task_id = data.get("task_id") # Ğ”Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹
    # ... Ğ·Ğ´ĞµÑÑŒ Ğ±ÑƒĞ´ĞµÑ‚ ĞºĞ¾Ğ´, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¸ÑˆĞµÑ‚ Ğ² TinyDB Ğ¸Ğ»Ğ¸ Ğ´Ñ€ÑƒĞ³ÑƒÑ Ğ±Ğ°Ğ·Ñƒ ...
    print(f"STATS: Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚. Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¾: {is_correct}")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ ("ÑĞ°Ğ¼/ÑĞ°Ğ¼Ğ°", "Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ")
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def handle_service_commands(message: Message, state: FSMContext) -> bool:
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚, ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹.
    Ğ•ÑĞ»Ğ¸ Ğ´Ğ° - Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ True.
    Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ False.
    """
    text = (message.text or "").strip().lower()

    if text in {"ÑĞ°Ğ¼", "ÑĞ°Ğ¼Ğ°"}:
        data = await state.get_data()
        gender = data.get("gender")
        student_name = data.get("student_name", "")
        
        word = "Ğ¡Ğ°Ğ¼Ğ°" if gender == "Ğ´ĞµĞ²Ğ¾Ñ‡ĞºĞ°" else "Ğ¡Ğ°Ğ¼"
        name_part = f", {student_name}" if student_name else ""
        
        await message.answer(f"Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾{name_part}, Ñ€ĞµÑˆĞ°Ğ¹ {word}. Ğ¯ Ğ²ĞµÑ€Ñ Ğ² Ñ‚ĞµĞ±Ñ! ğŸ™‚")
        return True # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ¸Ğ»Ğ¸, Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ°

    # Ğ¡ÑĞ´Ğ° Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ "Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ", ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° Ğ±ÑƒĞ´ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ¹
    # if text == "Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ":
    #     ...
    #     return True

    return False # Ğ­Ñ‚Ğ¾ Ğ½Ğµ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â„–6 â€” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#@router.message(TaskState.waiting_for_answer)
async def check_task6_answer(message: Message, state: FSMContext):
    # 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ Ğ»Ğ¸ ÑÑ‚Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°
    if await handle_service_commands(message, state):
        return

    # 2. Ğ”Ğ¾ÑÑ‚Ğ°Ñ‘Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¸Ğ· ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
    data = await state.get_data()
    correct_answers = data.get("correct_answers", [])
    if not correct_answers:
        await message.answer("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ â„–6. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°Ñ‡Ğ½Ğ¸ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.")
        await state.clear()
        return

    # 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
    #user_answer = message.text or ""
    #is_ok = any(answers_equal(user_answer, ca) for ca in correct_answers)
    
    # 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
    #await save_stats(state, is_correct=is_ok)

    # 5. Ğ ĞµĞ°Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    #if is_ok:
        await message.answer("âœ… Ğ’ĞµÑ€Ğ½Ğ¾! Ğ¢Ñ‹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´ĞµÑ†! Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ ĞµÑ‰Ñ‘ Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ?")
        await state.clear()
    else:
        await message.answer(
            "âŒ ĞĞµ ÑĞ¾Ğ²ÑĞµĞ¼ Ñ‚Ğ°Ğº. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.\n"
            "Ğ•ÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ, Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ <b>Â«ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒÂ»</b> Ğ½Ğ¸Ğ¶Ğµ ğŸ‘‡"
        )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â„–7 â€” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¿Ğ¾ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°Ğ¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#@router.message(TaskState.waiting_for_answer)
async def check_task7_answer(message: Message, state: FSMContext):
    # 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ½Ğµ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ğ°Ñ Ğ»Ğ¸ ÑÑ‚Ğ¾ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°
    if await handle_service_commands(message, state):
        return

    # 2. Ğ”Ğ¾ÑÑ‚Ğ°Ñ‘Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
    data = await state.get_data()
    correct_answer = (data.get("correct_answers") or [""])[0]
    options = data.get("task_options", [])
    
    if not correct_answer:
        await message.answer("ĞÑˆĞ¸Ğ±ĞºĞ°: Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ â„–7. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°Ñ‡Ğ½Ğ¸ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.")
        await state.clear()
        return

    # 3. "Ğ£Ğ¼Ğ½Ğ°Ñ" Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°
    user_answer = (message.text or "").strip()
    is_ok = False

    # 3.1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ğ²Ğ²ĞµĞ» Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ°
    if user_answer.isdigit():
        choice_index = int(user_answer) - 1
        if 0 <= choice_index < len(options) and options[choice_index] == correct_answer:
            is_ok = True
            
    # 3.2. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€ÑĞ¼Ğ¾Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ¼ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, "Ñ‚Ğ¾Ñ‡ĞºĞ° C")
    if not is_ok and user_answer.lower() == correct_answer.lower():
        is_ok = True

    # 4. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
    await save_stats(state, is_correct=is_ok)

    # 5. Ğ ĞµĞ°Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    if is_ok:
        await message.answer("âœ… ĞĞ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ğ¾ Ğ²ĞµÑ€Ğ½Ğ¾! ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°!")
        await state.clear()
    else:
        await message.answer(
            f"âŒ ĞĞ¹, Ğ½Ğµ ÑĞ¾Ğ²ÑĞµĞ¼ Ñ‚Ğ°Ğº. ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚: <b>{correct_answer}</b>\n\n"
            "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµÑˆÑŒ ĞµÑ‰Ğµ Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµĞµ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ?"
        )
        await state.clear()