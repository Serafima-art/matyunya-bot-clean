# -*- coding: utf-8 -*-
"""
–û–î–ù–û–†–ê–ó–û–í–´–ô –°–ö–†–ò–ü–¢-–ù–ê–ü–û–õ–ù–ò–¢–ï–õ–¨ ("–°–ò–î–ï–†")
=========================================

–ù–ê–ó–ù–ê–ß–ï–ù–ò–ï:
–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã 'skill_types'
–≤ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (`matunya.db`).

–ü–†–û–ë–õ–ï–ú–ê, –ö–û–¢–û–†–£–Æ –û–ù –†–ï–®–ê–ï–¢:
–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á (`register_task`) —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã –≤ —Ç–∞–±–ª–∏—Ü–µ 'skill_types'
—É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞ –∑–∞–ø–∏—Å—å –æ "–Ω–∞–≤—ã–∫–µ" (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'tires_q1_01'), –ø—Ä–µ–∂–¥–µ —á–µ–º
—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —ç—Ç–æ–π –∑–∞–¥–∞—á–∏. –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞,
—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.

–ö–ê–ö –û–ù –†–ê–ë–û–¢–ê–ï–¢:
1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫–∏–µ 'source_id' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ 'skill_types'.
3. –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ 'source_id' –∏–∑ —Å–ø–∏—Å–∫–∞ TIRES_SKILLS, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ –±–∞–∑–µ.

–ö–û–ì–î–ê –ï–ì–û –ó–ê–ü–£–°–ö–ê–¢–¨:
- –û–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
- –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –≤ –ø—Ä–æ–µ–∫—Ç –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ù–û–í–´–ï –ø–æ–¥—Ç–∏–ø—ã –∑–∞–¥–∞—á (–Ω–∞–ø—Ä–∏–º–µ—Ä,
  –∫–æ–≥–¥–∞ –º—ã –¥–æ–±–∞–≤–∏–º "–ü–µ—á–∏", –Ω–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö 'source_id' —Å—é–¥–∞ –∏
  –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞).

–ö–ê–ö –ó–ê–ü–£–°–ö–ê–¢–¨ (–∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ 'matunya' —Å –∞–∫—Ç–∏–≤–Ω—ã–º .venv):
python -m MASTERSKAYA.builders.populate_skills
"""

import asyncio
from sqlalchemy.future import select

# --- –í–ê–ñ–ù–û: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã ---
import matunya_bot_final.utils.db_manager as db_manager
from matunya_bot_final.utils.models import SkillType

# --- –°–ü–ò–°–û–ö –í–°–ï–• –ù–ê–í–´–ö–û–í –î–õ–Ø "–®–ò–ù" ---
# (–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ questions.json)
TIRES_SKILLS = [
    # Q1
    "tires_q1_01", "tires_q1_02", "tires_q1_03", "tires_q1_04", "tires_q1_05",
    # Q2
    "tires_q2_01", "tires_q2_02", "tires_q2_03", "tires_q2_04", "tires_q2_05",
    # Q3
    "tires_q3_01", "tires_q3_02", "tires_q3_03", "tires_q3_04", "tires_q3_05",
    # Q4
    "tires_q4_01", "tires_q4_02", "tires_q4_03", "tires_q4_04",
    # Q5
    "tires_q5_01", "tires_q5_02", "tires_q5_03", "tires_q5_04",
    # Q6
    "tires_q6_01", "tires_q6_02", "tires_q6_03", "tires_q6_04", "tires_q6_05",
]

async def main():
    print("üöÄ –ó–∞–ø—É—Å–∫ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã 'skill_types'...")

    # --- –®–ê–ì 1: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ë–î ---
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞—Å—Ç engine –∏ session_maker
    await db_manager.setup_database()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ session_maker –±—ã–ª —Å–æ–∑–¥–∞–Ω
    if not db_manager.session_maker:
        print("‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π.")
        return

    # --- –®–ê–ì 2: –†–∞–±–æ—Ç–∞–µ–º —Å —Å–µ—Å—Å–∏–µ–π ---
    # –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é —Å –ø–æ–º–æ—â—å—é session_maker
    async with db_manager.session_maker() as session:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ID, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
        result = await session.execute(select(SkillType.source_id))
        existing_ids = {row[0] for row in result.all()}
        print(f"‚ÑπÔ∏è  –í –±–∞–∑–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç {len(existing_ids)} –Ω–∞–≤—ã–∫–æ–≤.")

        new_skills_added = 0
        for skill_id in TIRES_SKILLS:
            if skill_id not in existing_ids:
                new_skill = SkillType(
                    source_id=skill_id,
                    name=f"–®–∏–Ω—ã: {skill_id}",
                    task_number="1-5",
                    description=f"–ù–∞–≤—ã–∫ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –®–∏–Ω—ã: {skill_id}"
                )
                session.add(new_skill)
                new_skills_added += 1
                print(f"  + –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫: {skill_id}")

        if new_skills_added > 0:
            await session.commit()
            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ {new_skills_added} –Ω–æ–≤—ã—Ö –Ω–∞–≤—ã–∫–æ–≤.")
        else:
            print("üëç –ù–æ–≤—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ë–∞–∑–∞ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.")


if __name__ == "__main__":
    asyncio.run(main())
